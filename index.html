<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Intervals.icu Activity Viewer</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background-color: Canvas;
        color: CanvasText;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem 1rem;
      }

      main {
        width: min(720px, 100%);
        border: 1px solid ColorMix(in srgb, CanvasText 20%, Canvas 80%);
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 24px 48px rgba(0, 0, 0, 0.05);
        background-color: ColorMix(in srgb, Canvas 96%, CanvasText 4%);
      }

      h1 {
        font-size: clamp(1.8rem, 2.5vw + 1rem, 2.5rem);
        margin-top: 0;
      }

      form {
        display: grid;
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      label {
        display: grid;
        gap: 0.35rem;
        font-weight: 600;
      }

      input {
        font: inherit;
        padding: 0.65rem 0.75rem;
        border-radius: 8px;
        border: 1px solid ColorMix(in srgb, CanvasText 15%, Canvas 85%);
        background-color: inherit;
        color: inherit;
      }

      button {
        font: inherit;
        font-weight: 600;
        padding: 0.75rem 1rem;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        justify-self: start;
        color: white;
        background: linear-gradient(135deg, #2279ff, #8c4bff);
      }

      button:disabled {
        opacity: 0.6;
        cursor: progress;
      }

      #status {
        min-height: 1.5rem;
        font-size: 0.95rem;
      }

      ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 0.75rem;
      }

      li {
        border: 1px solid ColorMix(in srgb, CanvasText 15%, Canvas 85%);
        border-radius: 12px;
        padding: 1rem;
        background: ColorMix(in srgb, Canvas 98%, CanvasText 2%);
      }

      li h2 {
        font-size: 1.1rem;
        margin: 0 0 0.35rem 0;
      }

      .meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem 1rem;
        font-size: 0.9rem;
        color: ColorMix(in srgb, CanvasText 60%, Canvas 40%);
      }

      code {
        font-family: "Fira Code", "SFMono-Regular", ui-monospace, monospace;
        background: ColorMix(in srgb, CanvasText 12%, Canvas 88%);
        padding: 0.15rem 0.4rem;
        border-radius: 4px;
        font-size: 0.85rem;
      }

      @media (max-width: 540px) {
        main {
          padding: 1.5rem;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <h1>Intervals.icu Activity Viewer</h1>
      <p>
        Use the proxy credentials configured in Vercel to authenticate and load the ten most recent activities for a given
        athlete. The request is sent to <code>/api/icu</code> on this deployment, so no Intervals.icu API key ever reaches
        the browser.
      </p>
      <form id="activity-form">
        <label>
          Proxy username
          <input type="text" id="proxy-user" name="proxyUser" autocomplete="username" required />
        </label>
        <label>
          Proxy password
          <input type="password" id="proxy-pass" name="proxyPass" autocomplete="current-password" required />
        </label>
        <label>
          Athlete ID
          <input
            type="text"
            id="athlete-id"
            name="athleteId"
            inputmode="text"
            pattern="i[0-9]+"
            placeholder="i123456"
            required
            title="Enter the Intervals.icu athlete ID, including the leading 'i'."
          />
        </label>
        <button type="submit">Load activities</button>
      </form>
      <div id="status" role="status"></div>
      <ul id="activity-list" aria-live="polite"></ul>
    </main>
    <script>
      const form = document.getElementById("activity-form");
      const statusEl = document.getElementById("status");
      const listEl = document.getElementById("activity-list");
      const button = form.querySelector("button[type=submit]");

      function formatDate(value) {
        if (!value) return "Unknown start time";
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return value;
        return date.toLocaleString();
      }

      function normaliseActivities(payload) {
        if (Array.isArray(payload)) return payload;
        if (payload && Array.isArray(payload.activities)) return payload.activities;
        if (payload && Array.isArray(payload.data)) return payload.data;
        return [];
      }

      async function loadActivities(event) {
        event.preventDefault();

        const proxyUser = form.proxyUser.value.trim();
        const proxyPass = form.proxyPass.value;
        const athleteId = form.athleteId.value.trim();

        if (!proxyUser || !proxyPass || !athleteId) {
          statusEl.textContent = "Please fill in all fields.";
          return;
        }

        listEl.innerHTML = "";
        statusEl.textContent = "Loading activitiesâ€¦";
        button.disabled = true;

        try {
          const encodedAuth = btoa(`${proxyUser}:${proxyPass}`);
          const response = await fetch(`/api/icu/athlete/${encodeURIComponent(athleteId)}/activities?limit=10`, {
            headers: {
              Authorization: `Basic ${encodedAuth}`,
              Accept: "application/json",
            },
          });

          if (!response.ok) {
            let detail = "";
            try {
              const errorBody = await response.json();
              detail = errorBody?.error ? ` ${errorBody.error}` : "";
            } catch (_) {
              // Ignore JSON parsing issues for non-JSON errors
            }
            throw new Error(`Request failed with status ${response.status}.${detail}`);
          }

          const payload = await response.json();
          const activities = normaliseActivities(payload).slice(0, 10);

          if (!activities.length) {
            statusEl.textContent = "No activities were returned.";
            return;
          }

          const fragment = document.createDocumentFragment();
          for (const activity of activities) {
            const item = document.createElement("li");

            const title = document.createElement("h2");
            title.textContent = activity.name || activity.title || `Activity ${activity.id ?? ""}`.trim();
            item.appendChild(title);

            const meta = document.createElement("div");
            meta.className = "meta";

            const start = document.createElement("span");
            start.textContent = `Start: ${formatDate(activity.start_date_local || activity.start_date || activity.start || activity.date)}`;
            meta.appendChild(start);

            if (activity.sport) {
              const sport = document.createElement("span");
              sport.textContent = `Sport: ${activity.sport}`;
              meta.appendChild(sport);
            }

            if (activity.distance) {
              const distance = document.createElement("span");
              distance.textContent = `Distance: ${activity.distance}`;
              meta.appendChild(distance);
            }

            item.appendChild(meta);

            if (activity.description) {
              const description = document.createElement("p");
              description.textContent = activity.description;
              item.appendChild(description);
            }

            fragment.appendChild(item);
          }

          listEl.appendChild(fragment);
          statusEl.textContent = "Loaded activities.";
        } catch (error) {
          console.error("Failed to load activities", error);
          statusEl.textContent = error.message || "Unable to load activities.";
        } finally {
          button.disabled = false;
        }
      }

      form.addEventListener("submit", loadActivities);
    </script>
  </body>
</html>
